<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MealCraft AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.2/dist/purify.min.js"></script>
  </head>
  <body>
    <header>
      <h2>MealCraft AI</h2>
      <nav>
        <!-- Navigation items for authentication and profile removed -->
      </nav>
    </header>

    <section class="hero">
      <h1>Welcome to MealCraft AI</h1>
      <p>Discover intelligent meal suggestions and perfect pairings with our sleek AI-driven experience.</p>

      <div style="margin-top:2rem;">
        <textarea id="userQuery" rows="3" style="width:60%;" placeholder="e.g., Suggest a high-protein vegan dinner idea"></textarea><br>
        <button onclick="sendQuery()">Ask AI</button>
        <button id="pairingButton" onclick="getBeveragePairings()" disabled>Drink Pairings</button>
        <button id="dishButton" onclick="getDishPairings()" disabled>Dish Pairings</button>
      </div>

      <div id="pairingResponse" class="response-box" style="display:none;"></div>
      <div id="dishResponse" class="response-box" style="display:none;"></div>
      <div id="aiResponse" class="response-box"></div>
    </section>
    <script>
      async function sendQuery() {
        const query = document.getElementById("userQuery").value.trim();
        const responseBox = document.getElementById("aiResponse");

        if (!query) {
          responseBox.innerHTML = "‚ö†Ô∏è Please type a question.";
          return;
        }

        const button = document.querySelector("button[onclick='sendQuery()']");
        button.disabled = true;
        button.textContent = "Processing...";
        responseBox.style.color = "#1e90ff";
        responseBox.innerHTML = "‚è≥ Generating response<span id='dots'></span>";

        // Animated dots indicator
        let dots = 0;
        const interval = setInterval(() => {
          dots = (dots + 1) % 4;
          document.getElementById("dots").textContent = ".".repeat(dots);
        }, 500);

        try {
          const res = await fetch("http://localhost:8020/api/v1/ai/respond", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
          });

          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Ask AI";

          if (!res.ok) {
            throw new Error(`Server returned ${res.status}`);
          }

          const data = await res.json();
          if (data.content) {
            responseBox.style.color = "#ffffff";
            const markdownHTML = DOMPurify.sanitize(marked.parse(data.content));
            responseBox.innerHTML = `‚úÖ <strong>(${data.type.toUpperCase()})</strong><hr>${markdownHTML}`;
            // Enable other buttons after successful AI response
            document.getElementById("pairingButton").disabled = false;
            document.getElementById("dishButton").disabled = false;
          } else if (data.detail) {
            responseBox.style.color = "#cc6600";
            responseBox.innerHTML = `‚ö†Ô∏è ${data.detail}`;
          } else {
            responseBox.style.color = "#cc6600";
            responseBox.innerHTML = "‚ö†Ô∏è No response received from MealCraft AI.";
          }
        } catch (err) {
          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Ask AI";
          responseBox.style.color = "#990000";
          responseBox.innerHTML = `‚ùå Error: ${err.message}. Please try again later.`;
        }
      }

      async function getBeveragePairings() {
        const query = document.getElementById("userQuery").value.trim();
        const pairingBox = document.getElementById("pairingResponse");

        if (!query) {
          pairingBox.style.display = "block";
          pairingBox.innerHTML = "‚ö†Ô∏è Please enter a recipe name first.";
          return;
        }

        const button = document.getElementById("pairingButton");
        button.disabled = true;
        button.textContent = "Fetching pairings...";
        pairingBox.style.display = "block";
        pairingBox.style.color = "#333";
        pairingBox.innerHTML = "‚è≥ Generating beverage pairings<span id='dotsPair'></span>";

        let dots = 0;
        const interval = setInterval(() => {
          dots = (dots + 1) % 4;
          document.getElementById("dotsPair").textContent = ".".repeat(dots);
        }, 500);

        try {
          const res = await fetch("http://localhost:8020/api/v1/ai/beverage-pairings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
          });

          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Give me beverage pairings for this recipe";

          if (!res.ok) {
            throw new Error(`Server returned ${res.status}`);
          }

          const data = await res.json();
          if (data.content) {
            pairingBox.style.color = "#ffffff";
            const markdownHTML = DOMPurify.sanitize(marked.parse(data.content));
            pairingBox.innerHTML = `üç∑ <strong>Beverage Pairings</strong><hr>${markdownHTML}`;
          } else if (data.detail) {
            pairingBox.style.color = "#cc6600";
            pairingBox.innerHTML = `‚ö†Ô∏è ${data.detail}`;
          } else {
            pairingBox.style.color = "#cc6600";
            pairingBox.innerHTML = "‚ö†Ô∏è No response received from MealCraft AI.";
          }
        } catch (err) {
          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Give me beverage pairings for this recipe";
          pairingBox.style.color = "#990000";
          pairingBox.innerHTML = `‚ùå Error: ${err.message}. Please try again later.`;
        }
      }

      async function getDishPairings() {
        const query = document.getElementById("userQuery").value.trim();
        const dishBox = document.getElementById("dishResponse");

        if (!query) {
          dishBox.style.display = "block";
          dishBox.innerHTML = "‚ö†Ô∏è Please enter a recipe name first.";
          return;
        }

        const button = document.getElementById("dishButton");
        button.disabled = true;
        button.textContent = "Fetching dish pairings...";
        dishBox.style.display = "block";
        dishBox.style.color = "#333";
        dishBox.innerHTML = "‚è≥ Generating dish pairings<span id='dotsDish'></span>";

        let dots = 0;
        const interval = setInterval(() => {
          dots = (dots + 1) % 4;
          document.getElementById("dotsDish").textContent = ".".repeat(dots);
        }, 500);

        try {
          const res = await fetch("http://localhost:8020/api/v1/ai/dish-pairings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
          });

          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Give me dish pairings for this recipe";

          if (!res.ok) {
            throw new Error(`Server returned ${res.status}`);
          }

          const data = await res.json();
          if (data.content) {
            dishBox.style.color = "#ffffff";
            const markdownHTML = DOMPurify.sanitize(marked.parse(data.content));
            dishBox.innerHTML = `üçΩÔ∏è <strong>Dish Pairings</strong><hr>${markdownHTML}`;
          } else if (data.detail) {
            dishBox.style.color = "#cc6600";
            dishBox.innerHTML = `‚ö†Ô∏è ${data.detail}`;
          } else {
            dishBox.style.color = "#cc6600";
            dishBox.innerHTML = "‚ö†Ô∏è No response received from MealCraft AI.";
          }
        } catch (err) {
          clearInterval(interval);
          button.disabled = false;
          button.textContent = "Give me dish pairings for this recipe";
          dishBox.style.color = "#990000";
          dishBox.innerHTML = `‚ùå Error: ${err.message}. Please try again later.`;
        }
      }
    </script>
  </body>
</html>
    <div style="font-size:0.8em; opacity:0.7; margin-top:30px;">
      Backend Status:
      <span class="status {{ 'ok' if data.status == 'ok' else 'error' }}">
        {{ data.status }}
      </span>
    </div>